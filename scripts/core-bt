#! /bin/bash

if [[ ( $# -gt 2 ) || ( $# -eq 0 ) ]]
then
    echo "$0 [executable] <core file>"
    exit 1
fi

execname=
corefile=

[[ $# -eq 2 ]] && execname=$1 corefile=$2
[[ $# -eq 1 ]] && execname=$($(dirname $0)/core-execname $1) corefile=$1

if [[ $execname == "" ]]
then
    echo "$execname: No such file"
    exit 1
fi

function is_tty {
    [[ -t 1 ]] && [[ -t 2 ]]
    return $?
}

RED=
NC=
is_tty && RED=$(echo -e "\001\033[1;31m\002")
is_tty && NC=$(echo -e "\001\033[0m\002")

echo "Core \`$(basename $corefile)' was generated by \`$execname'."
gdb --quiet -nx $execname -c $corefile <<EOF 2>&1 |
set width 0
set height 0
set pagination no
backtrace
EOF
sed -n                          \
    -e 's/^\((gdb) \)//'        \
    -e '/^#/p'                  \
    -e '/^Thread/p'             \
    -e '/^Program terminated/p' | sed -e 's/\(SIG[A-Z]*\)/'"${RED}\1${NC}/"

exit 0
